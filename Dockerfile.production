# ==============================================================================
# DOCKERFILE –î–õ–Ø –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û–ô –°–ë–û–†–ö–ò APK
# ==============================================================================
# –≠—Ç–æ—Ç Dockerfile —Å–æ–∑–¥–∞–Ω –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ–π —Å–±–æ—Ä–∫–∏ Android APK
# —á–µ—Ä–µ–∑ Buildozer + Python-for-Android
# ==============================================================================

FROM ubuntu:22.04

# ==============================================================================
# –°–ò–°–¢–ï–ú–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –û–ö–†–£–ñ–ï–ù–ò–Ø
# ==============================================================================

ENV DEBIAN_FRONTEND=noninteractive \
    # Android SDK –ø—É—Ç–∏
    ANDROID_HOME=/opt/android-sdk \
    ANDROID_SDK_ROOT=/opt/android-sdk \
    ANDROID_NDK_HOME=/opt/android-ndk \
    # Java
    JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64 \
    # PATH
    PATH="${PATH}:/opt/android-sdk/cmdline-tools/latest/bin:/opt/android-sdk/platform-tools:/opt/android-sdk/build-tools/34.0.0" \
    # Buildozer
    BUILDOZER_WARN_ON_ROOT=0 \
    # Python/Pip –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è --user –≤–Ω—É—Ç—Ä–∏ virtualenv
    PIP_USER=0 \
    PIP_NO_USER=1 \
    PIP_NO_USER_CONFIG=1 \
    PYTHONUNBUFFERED=1 \
    # –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    TMPDIR=/tmp \
    TMP=/tmp \
    TEMP=/tmp

# ==============================================================================
# –£–°–¢–ê–ù–û–í–ö–ê –ë–ê–ó–û–í–´–• –°–ò–°–¢–ï–ú–ù–´–• –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô
# ==============================================================================

RUN apt-get update && apt-get install -y --no-install-recommends \
    # Python –∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
    python3.10 python3.10-venv python3-pip \
    # –°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –≤–µ—Ä—Å–∏–π
    git \
    # –ê—Ä—Ö–∏–≤–∞—Ç–æ—Ä—ã
    zip unzip \
    # –£—Ç–∏–ª–∏—Ç—ã –∑–∞–≥—Ä—É–∑–∫–∏
    wget curl ca-certificates \
    # Java –¥–ª—è Android
    openjdk-17-jdk \
    # –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä—ã –∏ build tools
    build-essential ccache gcc g++ \
    # –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è Python –ø–∞–∫–µ—Ç–æ–≤
    libffi-dev libssl-dev \
    zlib1g-dev \
    libncurses5-dev libncursesw5-dev \
    libreadline-dev \
    libsqlite3-dev \
    libbz2-dev \
    liblzma-dev \
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã
    pkg-config \
    autoconf automake libtool \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# ==============================================================================
# –£–°–¢–ê–ù–û–í–ö–ê ANDROID SDK
# ==============================================================================

RUN mkdir -p ${ANDROID_HOME}/cmdline-tools && \
    cd ${ANDROID_HOME}/cmdline-tools && \
    wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip && \
    unzip -q commandlinetools-linux-9477386_latest.zip && \
    rm commandlinetools-linux-9477386_latest.zip && \
    mv cmdline-tools latest

# ==============================================================================
# –ù–ê–°–¢–†–û–ô–ö–ê ANDROID SDK –ò –£–°–¢–ê–ù–û–í–ö–ê –ö–û–ú–ü–û–ù–ï–ù–¢–û–í
# ==============================================================================

# –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è –ª–∏—Ü–µ–Ω–∑–∏–π
RUN mkdir -p /root/.android && \
    touch /root/.android/repositories.cfg

# –ü—Ä–∏–Ω–∏–º–∞–µ–º –ª–∏—Ü–µ–Ω–∑–∏–∏ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
RUN yes | ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --licenses || true && \
    ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --update && \
    ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager \
        "platform-tools" \
        "build-tools;34.0.0" \
        "platforms;android-31" \
        "ndk;25.2.9519653" \
        "cmake;3.22.1"

# –°–æ–∑–¥–∞–µ–º —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É –¥–ª—è NDK
RUN ln -s ${ANDROID_HOME}/ndk/25.2.9519653 ${ANDROID_NDK_HOME}

# ==============================================================================
# –£–°–¢–ê–ù–û–í–ö–ê PYTHON –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô (–ë–ï–ó VIRTUALENV)
# ==============================================================================
# –í Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ virtualenv –∏–∑–±—ã—Ç–æ—á–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π Python
# Buildozer —Å–æ–∑–¥–∞—Å—Ç —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π venv –ø—Ä–∏ —Å–±–æ—Ä–∫–µ APK

# –û–±–Ω–æ–≤–ª—è–µ–º pip, setuptools, wheel
RUN python3 -m pip install --no-cache-dir --upgrade \
    pip>=23.0 \
    setuptools>=65.0 \
    wheel>=0.38

# ==============================================================================
# –£–°–¢–ê–ù–û–í–ö–ê BUILDOZER –ò –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô
# ==============================================================================

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Cython (–≤–∞–∂–Ω–æ –¥–ª—è p4a)
RUN python3 -m pip install --no-cache-dir "Cython==0.29.33"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã
RUN python3 -m pip install --no-cache-dir \
    colorama \
    appdirs \
    pyyaml

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Buildozer –∏ python-for-android
# (–æ–Ω–∏ –º–æ–≥—É—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å sh>=2.0 –∫–∞–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å)
RUN python3 -m pip install --no-cache-dir "buildozer==1.5.0" "python-for-android"

# –ö–†–ò–¢–ò–ß–ù–û: –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º sh —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π –ü–û–°–õ–ï –≤—Å–µ—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
# –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ python-for-android –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –≤–µ—Ä—Å–∏—é
RUN python3 -m pip install --no-cache-dir --force-reinstall "sh>=1.10,<2.0"

# –ù–∞—Ö–æ–¥–∏–º –≥–¥–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã Python —Å–∫—Ä–∏–ø—Ç—ã –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ PATH
RUN PYTHON_BIN=$(python3 -c "import site; print(site.USER_BASE + '/bin')") && \
    echo "Python scripts path: $PYTHON_BIN" && \
    mkdir -p $PYTHON_BIN

# –î–æ–±–∞–≤–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–æ —Å–∫—Ä–∏–ø—Ç–∞–º–∏ Python –≤ PATH
ENV PATH="/root/.local/bin:/usr/local/bin:$PATH"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ cython –¥–æ—Å—Ç—É–ø–µ–Ω (—Å–æ–∑–¥–∞—ë–º —Å–∏–º–ª–∏–Ω–∫ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
RUN which cython || ln -sf /usr/local/bin/cython3 /usr/local/bin/cython || \
    (find /usr/local -name cython -type f 2>/dev/null | head -1 | xargs -I {} ln -sf {} /usr/local/bin/cython)

# ==============================================================================
# –ù–ê–°–¢–†–û–ô–ö–ê –†–ê–ë–û–ß–ï–ô –î–ò–†–ï–ö–¢–û–†–ò–ò
# ==============================================================================

WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞
COPY . /app

# ==============================================================================
# –°–û–ó–î–ê–ù–ò–ï –ù–ï–û–ë–•–û–î–ò–ú–´–• –î–ò–†–ï–ö–¢–û–†–ò–ô
# ==============================================================================

RUN mkdir -p \
    /root/.buildozer/android/platform \
    /root/.buildozer/.android \
    /root/.cache \
    /tmp/buildozer && \
    chmod 1777 /tmp && \
    chmod -R 755 /root/.cache

# ==============================================================================
# –°–û–ó–î–ê–ù–ò–ï BUILD –°–ö–†–ò–ü–¢–ê
# ==============================================================================

RUN printf '#!/bin/bash\n\
set -e\n\
set -x\n\
\n\
echo "========================================"\n\
echo "üöÄ BUILDOZER APK BUILD SCRIPT"\n\
echo "========================================"\n\
\n\
# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ\n\
echo ""\n\
echo "üìã System Information:"\n\
echo "  Python: $(python3 --version)"\n\
echo "  Buildozer: $(python3 -m buildozer --version)"\n\
echo "  Working Dir: $(pwd)"\n\
echo "  Java: $JAVA_HOME"\n\
echo "  Android SDK: $ANDROID_HOME"\n\
echo "  Android NDK: $ANDROID_NDK_HOME"\n\
echo ""\n\
\n\
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ\n\
echo "üíæ Disk Space:"\n\
df -h /\n\
echo ""\n\
\n\
# –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–±–æ—Ä–æ–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)\n\
if [ "$CLEAN_BUILD" = "1" ]; then\n\
  echo "üßπ Cleaning previous builds..."\n\
  rm -rf .buildozer bin __pycache__\n\
  echo "‚úÖ Clean complete"\n\
fi\n\
\n\
# –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º sh<2.0 –ü–ï–†–ï–î –∑–∞–ø—É—Å–∫–æ–º buildozer\n\
echo ""\n\
echo "üîß Fixing sh version before buildozer..."\n\
python3 -m pip uninstall -y sh\n\
python3 -m pip install --no-cache-dir "sh>=1.10,<2.0"\n\
echo "‚úÖ sh version fixed: $(python3 -c \"import sh; print(sh.__version__)\")"\n\
echo ""\n\
\n\
# –ó–∞–ø—É—Å–∫ Buildozer\n\
echo ""\n\
echo "========================================"\n\
echo "üî® Starting Buildozer Build"\n\
echo "========================================"\n\
\n\
python3 -m buildozer -v android debug 2>&1 | tee /app/buildozer_full.log\n\
\n\
EXIT_CODE=${PIPESTATUS[0]}\n\
\n\
if [ $EXIT_CODE -ne 0 ]; then\n\
  echo ""\n\
  echo "========================================"\n\
  echo "‚ùå BUILD FAILED (Exit Code: $EXIT_CODE)"\n\
  echo "========================================"\n\
  echo ""\n\
  echo "üìÑ Last 100 lines of log:"\n\
  tail -n 100 /app/buildozer_full.log\n\
  exit $EXIT_CODE\n\
fi\n\
\n\
echo ""\n\
echo "========================================"\n\
echo "‚úÖ BUILD SUCCESSFUL"\n\
echo "========================================"\n\
\n\
# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç\n\
if [ -d "bin" ]; then\n\
  echo ""\n\
  echo "üì¶ Generated APK files:"\n\
  ls -lh bin/*.apk || echo "No APK found"\n\
  echo ""\n\
fi\n\
\n\
echo "üéâ Build completed successfully!"\n\
' > /usr/local/bin/build-apk && \
    chmod +x /usr/local/bin/build-apk

# ==============================================================================
# ENTRYPOINT
# ==============================================================================

CMD ["/usr/local/bin/build-apk"]
