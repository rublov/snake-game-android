# ==============================================================================
# DOCKERFILE Ð”Ð›Ð¯ Ð“ÐÐ ÐÐÐ¢Ð˜Ð ÐžÐ’ÐÐÐÐžÐ™ Ð¡Ð‘ÐžÐ ÐšÐ˜ APK
# ==============================================================================
# Ð­Ñ‚Ð¾Ñ‚ Dockerfile ÑÐ¾Ð·Ð´Ð°Ð½ Ð´Ð»Ñ ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾Ð¹ Ð¸ Ð²Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ð¼Ð¾Ð¹ ÑÐ±Ð¾Ñ€ÐºÐ¸ Android APK
# Ñ‡ÐµÑ€ÐµÐ· Buildozer + Python-for-Android
# ==============================================================================

FROM ubuntu:22.04

# ==============================================================================
# Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐÐ«Ð• ÐŸÐ•Ð Ð•ÐœÐ•ÐÐÐ«Ð• ÐžÐšÐ Ð£Ð–Ð•ÐÐ˜Ð¯
# ==============================================================================

ENV DEBIAN_FRONTEND=noninteractive \
    # Android SDK Ð¿ÑƒÑ‚Ð¸
    ANDROID_HOME=/opt/android-sdk \
    ANDROID_SDK_ROOT=/opt/android-sdk \
    ANDROID_NDK_HOME=/opt/android-ndk \
    # Java
    JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64 \
    # PATH
    PATH="${PATH}:/opt/android-sdk/cmdline-tools/latest/bin:/opt/android-sdk/platform-tools:/opt/android-sdk/build-tools/34.0.0" \
    # Buildozer
    BUILDOZER_WARN_ON_ROOT=0 \
    # Python/Pip Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð´Ð»Ñ Ð¸Ð·Ð±ÐµÐ¶Ð°Ð½Ð¸Ñ --user Ð²Ð½ÑƒÑ‚Ñ€Ð¸ virtualenv
    PIP_USER=0 \
    PIP_NO_USER=1 \
    PIP_NO_USER_CONFIG=1 \
    PYTHONUNBUFFERED=1 \
    # Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
    TMPDIR=/tmp \
    TMP=/tmp \
    TEMP=/tmp

# ==============================================================================
# Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ Ð‘ÐÐ—ÐžÐ’Ð«Ð¥ Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐÐ«Ð¥ Ð—ÐÐ’Ð˜Ð¡Ð˜ÐœÐžÐ¡Ð¢Ð•Ð™
# ==============================================================================

RUN apt-get update && apt-get install -y --no-install-recommends \
    # Python Ð¸ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
    python3.10 python3.10-venv python3-pip \
    # Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ñ Ð²ÐµÑ€ÑÐ¸Ð¹
    git \
    # ÐÑ€Ñ…Ð¸Ð²Ð°Ñ‚Ð¾Ñ€Ñ‹
    zip unzip \
    # Ð£Ñ‚Ð¸Ð»Ð¸Ñ‚Ñ‹ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸
    wget curl ca-certificates \
    # Java Ð´Ð»Ñ Android
    openjdk-17-jdk \
    # ÐšÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ‚Ð¾Ñ€Ñ‹ Ð¸ build tools
    build-essential ccache gcc g++ \
    # Ð‘Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸ Ð´Ð»Ñ Python Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
    libffi-dev libssl-dev \
    zlib1g-dev \
    libncurses5-dev libncursesw5-dev \
    libreadline-dev \
    libsqlite3-dev \
    libbz2-dev \
    liblzma-dev \
    # Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚Ñ‹
    pkg-config \
    autoconf automake libtool \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# ==============================================================================
# Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ ANDROID SDK
# ==============================================================================

RUN mkdir -p ${ANDROID_HOME}/cmdline-tools && \
    cd ${ANDROID_HOME}/cmdline-tools && \
    wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip && \
    unzip -q commandlinetools-linux-9477386_latest.zip && \
    rm commandlinetools-linux-9477386_latest.zip && \
    mv cmdline-tools latest

# ==============================================================================
# ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ ANDROID SDK Ð˜ Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ ÐšÐžÐœÐŸÐžÐÐ•ÐÐ¢ÐžÐ’
# ==============================================================================

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð¸Ñ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¹
RUN mkdir -p /root/.android && \
    touch /root/.android/repositories.cfg

# ÐŸÑ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÐ¼ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¸ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹
RUN yes | ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --licenses || true && \
    ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --update && \
    ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager \
        "platform-tools" \
        "build-tools;34.0.0" \
        "platforms;android-31" \
        "ndk;25.2.9519653" \
        "cmake;3.22.1"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¸Ñ‡ÐµÑÐºÑƒÑŽ ÑÑÑ‹Ð»ÐºÑƒ Ð´Ð»Ñ NDK
RUN ln -s ${ANDROID_HOME}/ndk/25.2.9519653 ${ANDROID_NDK_HOME}

# ==============================================================================
# Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ PYTHON Ð—ÐÐ’Ð˜Ð¡Ð˜ÐœÐžÐ¡Ð¢Ð•Ð™ (Ð‘Ð•Ð— VIRTUALENV)
# ==============================================================================
# Ð’ Docker ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ðµ virtualenv Ð¸Ð·Ð±Ñ‹Ñ‚Ð¾Ñ‡ÐµÐ½ - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ð¹ Python
# Buildozer ÑÐ¾Ð·Ð´Ð°ÑÑ‚ ÑÐ²Ð¾Ð¹ ÑÐ¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ venv Ð¿Ñ€Ð¸ ÑÐ±Ð¾Ñ€ÐºÐµ APK

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ pip, setuptools, wheel
RUN python3 -m pip install --no-cache-dir --upgrade \
    pip>=23.0 \
    setuptools>=65.0 \
    wheel>=0.38

# ==============================================================================
# Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ BUILDOZER Ð˜ Ð—ÐÐ’Ð˜Ð¡Ð˜ÐœÐžÐ¡Ð¢Ð•Ð™
# ==============================================================================

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Cython (Ð²Ð°Ð¶Ð½Ð¾ Ð´Ð»Ñ p4a)
RUN python3 -m pip install --no-cache-dir "Cython==0.29.33"

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚Ñ‹
RUN python3 -m pip install --no-cache-dir \
    colorama \
    appdirs \
    pyyaml

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Buildozer Ð¸ python-for-android
# (Ð¾Ð½Ð¸ Ð¼Ð¾Ð³ÑƒÑ‚ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ sh>=2.0 ÐºÐ°Ðº Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑŒ)
RUN python3 -m pip install --no-cache-dir "buildozer==1.5.0" "python-for-android"

# ÐšÐ Ð˜Ð¢Ð˜Ð§ÐÐž: ÐŸÐµÑ€ÐµÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ sh Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸ÐµÐ¹ ÐŸÐžÐ¡Ð›Ð• Ð²ÑÐµÑ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
# Ð­Ñ‚Ð¾ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ Ñ‡Ñ‚Ð¾ python-for-android Ð½Ðµ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑˆÐµÑ‚ Ð²ÐµÑ€ÑÐ¸ÑŽ
RUN python3 -m pip install --no-cache-dir --force-reinstall "sh>=1.10,<2.0"

# ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð³Ð´Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ Python ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð² PATH
RUN PYTHON_BIN=$(python3 -c "import site; print(site.USER_BASE + '/bin')") && \
    echo "Python scripts path: $PYTHON_BIN" && \
    mkdir -p $PYTHON_BIN

# Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ ÑÐ¾ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°Ð¼Ð¸ Python Ð² PATH
ENV PATH="/root/.local/bin:/usr/local/bin:$PATH"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ cython Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ (ÑÐ¾Ð·Ð´Ð°Ñ‘Ð¼ ÑÐ¸Ð¼Ð»Ð¸Ð½Ðº ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)
RUN which cython || ln -sf /usr/local/bin/cython3 /usr/local/bin/cython || \
    (find /usr/local -name cython -type f 2>/dev/null | head -1 | xargs -I {} ln -sf {} /usr/local/bin/cython)

# ==============================================================================
# ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ Ð ÐÐ‘ÐžÐ§Ð•Ð™ Ð”Ð˜Ð Ð•ÐšÐ¢ÐžÐ Ð˜Ð˜
# ==============================================================================

WORKDIR /app

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
COPY . /app

# ==============================================================================
# Ð¡ÐžÐ—Ð”ÐÐÐ˜Ð• ÐÐ•ÐžÐ‘Ð¥ÐžÐ”Ð˜ÐœÐ«Ð¥ Ð”Ð˜Ð Ð•ÐšÐ¢ÐžÐ Ð˜Ð™
# ==============================================================================

RUN mkdir -p \
    /root/.buildozer/android/platform \
    /root/.buildozer/.android \
    /root/.cache \
    /tmp/buildozer && \
    chmod 1777 /tmp && \
    chmod -R 755 /root/.cache

# ==============================================================================
# Ð¡ÐžÐ—Ð”ÐÐÐ˜Ð• BUILD Ð¡ÐšÐ Ð˜ÐŸÐ¢Ð
# ==============================================================================

RUN printf '#!/bin/bash\n\
set -e\n\
set -x\n\
\n\
echo "========================================"\n\
echo "ðŸš€ BUILDOZER APK BUILD SCRIPT"\n\
echo "========================================"\n\
\n\
# Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ\n\
echo ""\n\
echo "ðŸ“‹ System Information:"\n\
echo "  Python: $(python3 --version)"\n\
echo "  Buildozer: $(python3 -m buildozer --version)"\n\
echo "  Working Dir: $(pwd)"\n\
echo "  Java: $JAVA_HOME"\n\
echo "  Android SDK: $ANDROID_HOME"\n\
echo "  Android NDK: $ANDROID_NDK_HOME"\n\
echo ""\n\
\n\
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¼ÐµÑÑ‚Ð° Ð½Ð° Ð´Ð¸ÑÐºÐµ\n\
echo "ðŸ’¾ Disk Space:"\n\
df -h /\n\
echo ""\n\
\n\
# ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ñ… ÑÐ±Ð¾Ñ€Ð¾Ðº (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)\n\
if [ "$CLEAN_BUILD" = "1" ]; then\n\
  echo "ðŸ§¹ Cleaning previous builds..."\n\
  rm -rf .buildozer bin __pycache__\n\
  echo "âœ… Clean complete"\n\
fi\n\
\n\
# Ð—Ð°Ð¿ÑƒÑÐº Buildozer\n\
echo ""\n\
echo "========================================"\n\
echo "ðŸ”¨ Starting Buildozer Build"\n\
echo "========================================"\n\
\n\
python3 -m buildozer -v android debug 2>&1 | tee /app/buildozer_full.log\n\
\n\
EXIT_CODE=${PIPESTATUS[0]}\n\
\n\
if [ $EXIT_CODE -ne 0 ]; then\n\
  echo ""\n\
  echo "========================================"\n\
  echo "âŒ BUILD FAILED (Exit Code: $EXIT_CODE)"\n\
  echo "========================================"\n\
  echo ""\n\
  echo "ðŸ“„ Last 100 lines of log:"\n\
  tail -n 100 /app/buildozer_full.log\n\
  exit $EXIT_CODE\n\
fi\n\
\n\
echo ""\n\
echo "========================================"\n\
echo "âœ… BUILD SUCCESSFUL"\n\
echo "========================================"\n\
\n\
# ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚\n\
if [ -d "bin" ]; then\n\
  echo ""\n\
  echo "ðŸ“¦ Generated APK files:"\n\
  ls -lh bin/*.apk || echo "No APK found"\n\
  echo ""\n\
fi\n\
\n\
echo "ðŸŽ‰ Build completed successfully!"\n\
' > /usr/local/bin/build-apk && \
    chmod +x /usr/local/bin/build-apk

# ==============================================================================
# ENTRYPOINT
# ==============================================================================

CMD ["/usr/local/bin/build-apk"]
