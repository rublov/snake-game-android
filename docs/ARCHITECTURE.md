# Архитектура проекта Snake Game

## Цели

- Разделить игровую механику и графические адаптеры (Kivy, Pygame).
- Обеспечить единое ядро с чистой логикой для повторного использования и тестирования.
- Выделить инфраструктурные сервисы (логирование, звук, управление состоянием).
- Подготовить базу для последующих платформенных клиентов и автоматического тестирования.

## Пакеты и модули

```text
snake_game/
  __init__.py
  core/
    __init__.py
    constants.py        # Общие константы (цвета, размеры клеток и т.д.)
    direction.py        # Перечисление направлений движения змеи
    events.py           # Описание событий игрового шага
    game.py             # Главный движок: состояние, шаги, генерация еды
    state.py            # dataclass-и для хранения состояния
  services/
    __init__.py
    audio.py            # Абстракция звуковых эффектов и загрузки звуков
    session.py          # Управление жизненным циклом игры (пауза, рестарт, скорость)
  ui/
    __init__.py
    kivy_app.py         # UI-логика Kivy: SnakeBoard, SnakeApp
    pygame_app.py       # UI-логика на Pygame (минимальная, для совместимости)
```

Дополнительно создаются файлы верхнего уровня:

- `logging_config.py` — единая конфигурация логов для всех клиентов.
- `main.py` — точка входа, выбирающая подходящий UI (по умолчанию Kivy).
- `pygame_adapter.py` / `kivy_adapter.py` — тонкие оболочки вокруг соответствующих приложений из каталога `snake_game.ui`.

## Основные потоки данных

1. UI слой (Kivy/Pygame) создаёт экземпляр `SnakeSession`, который оборачивает `SnakeGameEngine` из `snake_game.core.game`.
2. `SnakeSession` принимает события ввода (из UI) и преобразует их в команды для движка (`set_direction`, `step`).
3. После каждого шага `SnakeSession.step()` возвращает `GameStepResult`, который содержит флаги (`food_eaten`, `speed_changed`, `game_over`). UI реагирует на них (обновляет счёт, перестраивает расписание, проигрывает звук).
4. Звуковая подсистема (`SnakeSoundManager`) из `snake_game.services.audio` отвечает за загрузку и проигрывание эффектов, используя переданный адаптер (`SoundLoader` для Kivy, `pygame.mixer.Sound` для Pygame).

## Размер поля и адаптация UI

- `SnakeBoard` отслеживает изменения размеров (`on_size`) и вызывает `SnakeSession.resize(cols, rows)`, пересчитывая сетку из текущих пикселей и `CELL_SIZE`.
- После изменения размера фрагмент экрана перерисовывается заново, используя данные из `SnakeGameState`.

## Тестирование

- Юнит-тесты логики (`tests/test_core_game.py`) используют только модуль `snake_game.core.game`.
- Smoke-тест Kivy (`tests/test_kivy_smoke.py`) инициализирует `SnakeApp` с `EventLoop.ensure_window()` и проверяет старт/остановку без ошибок.

## Качество кода

- Управление зависимостями и инструментами оформления определено в `pyproject.toml` (black, ruff, mypy).
- GitHub Actions запускает линтеры, mypy и pytest перед сборкой APK.

## Миграция

- Наследие `Snake Game.py` остаётся как legacy-слой, но постепенно переводится на новую архитектуру; первыми потребителями ядра становятся Kivy и новый Pygame адаптер.
- Существующие тесты обновляются для работы с новым ядром, чтобы не зависеть от Pygame.
